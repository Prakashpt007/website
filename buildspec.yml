version: 0.2
phases:
    pre_build:
        commands:
            - echo Logging into Docker Hub started on `date`
            - echo Logging into Docker Hub...
            - echo "QQAb57L8%hJ:^@-?" | docker login --username "cdtdrktscloud" --password-stdin
            - echo Logging into Amazon ECR....
            - aws ecr get-login-password --region ap-south-1 | docker login --username AWS --password-stdin 047198061298.dkr.ecr.ap-south-1.amazonaws.com
            - echo Setting repository URI....
            - export REPOSITORY_URI=047198061298.dkr.ecr.ap-south-1.amazonaws.com/unifiedappadminfrontend

    build:
        commands:
            - echo Building the Docker image...
            - docker build -f Dockerfile -t $REPOSITORY_URI:latest .
            - echo Tagging the Docker image...
            - export IMAGE_TAG=$(echo $CODEBUILD_BUILD_ID | awk -F":" '{print $2}')
            - docker tag $REPOSITORY_URI:latest $REPOSITORY_URI:$IMAGE_TAG

    post_build:
        commands:
            - echo Pushing Docker image to Amazon ECR started on `date`
            - echo Pushing to repository...
            - docker push $REPOSITORY_URI:latest
            - docker push $REPOSITORY_URI:$IMAGE_TAG
            - echo Setting container name...
            - export DOCKER_CONTAINER_NAME=unifiedappadminfrontend
            - echo Writing image definitions file...
            - printf '[{"name":"%s","imageUri":"%s"}]' $DOCKER_CONTAINER_NAME $REPOSITORY_URI:$IMAGE_TAG > imagedefinitions.json
            - echo $DOCKER_CONTAINER_NAME
            - echo Printing imagedefinitions.json
            - cat imagedefinitions.json
artifacts:
    files:
        - target/*.jar
        - scripts/*.sh
        - appspec.yml
        - imagedefinitions.json
    discard-paths: yes
